@using EmeraldBot.Model
@using EmeraldBot.Model.Servers
@using Microsoft.AspNetCore.SignalR.Client;
@using Microsoft.Extensions.DependencyInjection;
@using Microsoft.AspNetCore.Http;
@using Microsoft.AspNetCore.Http.Connections;

@inject EmeraldBotContext _ctx
@inject IHttpContextAccessor _ca

<FormGroup>
    <BlazorLabel>Pick a Server</BlazorLabel>
    <Dropdown IsOpen="@IsOpen">
        <DropdownToggle @onclick="@OnClick">@(Servers.Count > 0 ? Servers.Find(x => x.ID == _serverID).Name : "Loading...")</DropdownToggle>
        <DropdownMenu IsOpen="@IsOpen">
            @foreach (var s in Servers)
            {
                <DropdownItem @key="@s.ID" @onclick="@((e) => ServerSelected(s.ID))">@s.Name</DropdownItem>
            }
        </DropdownMenu>
    </Dropdown>
</FormGroup>

@code  {
[CascadingParameter(Name = "UserID")] protected int UserID { get; set; }
[Parameter] private EventCallback<int> OnSelected { get; set; }
private bool IsOpen;
private List<Server> Servers = new List<Server>();
private int _serverID = -1;

protected override async Task OnInitAsync()
{
    if (UserID == -1) return;
    // Create the connection
    HubConnection connection = new HubConnectionBuilder()
            .AddMessagePackProtocol()
            .WithAutomaticReconnect()
            .WithUrl(Urls.BotHub,
            opt =>
            {
                opt.Transports = HttpTransportType.WebSockets;
            })
            .Build();
    await connection.StartAsync();

    // Find the servers the user is on
    List<int> ids = await connection.InvokeAsync<List<int>>("GetUserGuilds", UserID);
    await connection.StopAsync();
    Servers = ids.Select(x => _ctx.Servers.Find(x)).ToList();
    _serverID = Servers[0].ID;
    await OnSelected.InvokeAsync(_serverID);
}

protected async Task ServerSelected(int newSelection)
{
    if (newSelection != _serverID)
    {
        _serverID = newSelection;
        await OnSelected.InvokeAsync(_serverID);
    }
    IsOpen = false;
}

private void OnClick(UIMouseEventArgs e)
{
    IsOpen = !IsOpen;
    StateHasChanged();
}
}